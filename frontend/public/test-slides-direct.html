<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Slides Test</title>
    <style>
        body {
            font-family: Arial;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .controls {
            margin-bottom: 20px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover { background: #0056b3; }
        #status {
            padding: 20px;
            margin: 20px 0;
            background: #e9ecef;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        #slides {
            border: 2px solid #dee2e6;
            padding: 20px;
            min-height: 300px;
            border-radius: 8px;
            background: white;
        }
        .slide {
            padding: 20px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f8f9fa;
        }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 300px;
        }
    </style>
</head>
<body>
    <h1>üîç Direct Slides API Test</h1>

    <div class="controls">
        <h3>Test Controls:</h3>
        <div>
            <input id="token" placeholder="JWT Token" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI3N2Q3MzMxMS01YTBiLTQ4OWEtYWU3My0wOGZjYjc4YjIzZmIiLCJlbWFpbCI6InNsaWRldGVzdEBleGFtcGxlLmNvbSIsInJvbGUiOiJTVFVERU5UIiwiaWF0IjoxNzU4OTI5ODUzLCJleHAiOjE3NTk1MzQ2NTN9.qqe45UzgGj0NtM6bmuw-vVVvr-wo9pIY-nrkCU9jSW0">
        </div>
        <div>
            <input id="lessonId" placeholder="Lesson ID" value="LESSON_1758905299464_qjan5xlid">
        </div>
        <div>
            <input id="jobId" placeholder="Job ID (optional - for checking existing job)">
        </div>
        <div>
            <button onclick="requestSlides()">1Ô∏è‚É£ Request Slides (Start Job)</button>
            <button onclick="checkSpecificJob()">2Ô∏è‚É£ Check Specific Job Status</button>
            <button onclick="testRecentJobs()">3Ô∏è‚É£ Test Recent Jobs (67-70)</button>
            <button onclick="clearLog()">üßπ Clear Log</button>
        </div>
    </div>

    <div id="status">Ready to test...</div>
    <div id="slides"></div>

    <script>
        const API_URL = 'http://localhost:3001';
        let currentJobId = null;
        let pollingInterval = null;

        function log(message, type = 'info') {
            const status = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            status.innerHTML += `[${timestamp}] <span class="${className}">${message}</span>\n`;
            console.log(`[${type}]`, message);
        }

        function clearLog() {
            document.getElementById('status').innerHTML = 'Log cleared. Ready to test...\n';
            document.getElementById('slides').innerHTML = '';
        }

        async function requestSlides() {
            const token = document.getElementById('token').value;
            const lessonId = document.getElementById('lessonId').value;
            const sessionId = `session-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

            log('üì§ Requesting slides...', 'info');
            log(`Session ID: ${sessionId}`, 'info');

            try {
                const response = await fetch(`${API_URL}/api/v1/lessons/${lessonId}/slides?theme=default&generateVoice=true&generateTeaching=true`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'X-Session-Id': sessionId,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                log(`Response status: ${response.status}`, response.ok ? 'success' : 'error');

                if (data.data?.jobId) {
                    currentJobId = data.data.jobId;
                    document.getElementById('jobId').value = currentJobId;
                    log(`‚úÖ Job created: ${currentJobId}`, 'success');
                    log('Starting automatic polling...', 'info');
                    startPolling(currentJobId);
                } else if (data.data?.slides) {
                    log(`‚úÖ Got ${data.data.slides.length} slides directly!`, 'success');
                    displaySlides(data.data.slides);
                } else {
                    log(`Response: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        async function checkJobStatus(jobId) {
            const token = document.getElementById('token').value;

            try {
                const response = await fetch(`${API_URL}/api/v1/lessons/slides/job/${jobId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    log(`Job ${jobId}: ${response.status} - ${data.error?.message || 'Error'}`, 'error');
                    return null;
                }

                log(`Job ${jobId} status: ${data.data.status}`, 'info');

                if (data.data.status === 'completed' && data.data.slides) {
                    log(`‚úÖ Job ${jobId} completed with ${data.data.slides.length} slides!`, 'success');
                    displaySlides(data.data.slides);
                    stopPolling();
                    return data.data;
                } else if (data.data.status === 'failed') {
                    log(`‚ùå Job ${jobId} failed: ${data.data.error}`, 'error');
                    stopPolling();
                    return null;
                }

                return data.data;
            } catch (error) {
                log(`Error checking job ${jobId}: ${error.message}`, 'error');
                return null;
            }
        }

        function startPolling(jobId) {
            stopPolling(); // Clear any existing interval
            log(`üîÑ Starting polling for job ${jobId}...`, 'info');

            // Check immediately
            checkJobStatus(jobId);

            // Then poll every 2 seconds
            pollingInterval = setInterval(() => {
                log(`‚è∞ Polling job ${jobId}...`, 'info');
                checkJobStatus(jobId);
            }, 2000);
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                log('üõë Polling stopped', 'info');
            }
        }

        async function checkSpecificJob() {
            const jobId = document.getElementById('jobId').value;
            if (!jobId) {
                log('Please enter a Job ID', 'error');
                return;
            }

            log(`üîç Checking job ${jobId}...`, 'info');
            const result = await checkJobStatus(jobId);

            if (result && result.status === 'processing') {
                log('Job still processing, starting polling...', 'info');
                startPolling(jobId);
            }
        }

        async function testRecentJobs() {
            log('üß™ Testing recent jobs (70 to 67)...', 'info');

            for (let jobId = 70; jobId >= 67; jobId--) {
                const result = await checkJobStatus(jobId);
                if (result && result.slides && result.slides.length > 0) {
                    log(`üéâ Found working job ${jobId} with slides!`, 'success');
                    break;
                }
            }
        }

        function displaySlides(slides) {
            const container = document.getElementById('slides');
            container.innerHTML = '<h2>üìö Slides:</h2>';

            slides.forEach((slide, index) => {
                const slideDiv = document.createElement('div');
                slideDiv.className = 'slide';
                slideDiv.innerHTML = `
                    <h3>Slide ${index + 1}</h3>
                    <p><strong>Type:</strong> ${slide.type || 'content'}</p>
                    <p><strong>Title:</strong> ${slide.title || 'N/A'}</p>
                    <p><strong>Has HTML:</strong> ${slide.html ? '‚úÖ' : '‚ùå'}</p>
                    <p><strong>Has Audio:</strong> ${slide.audioUrl ? '‚úÖ' : '‚ùå'}</p>
                    <p><strong>Has Teaching Script:</strong> ${slide.teachingScript ? '‚úÖ' : '‚ùå'}</p>
                    ${slide.bullets ? `<p><strong>Bullets:</strong> ${slide.bullets.length} items</p>` : ''}
                `;
                container.appendChild(slideDiv);
            });
        }

        // Test on load
        window.onload = () => {
            log('üöÄ Test page ready!', 'success');
            log('Click "Request Slides" to start a new job', 'info');
            log('Or enter a Job ID and click "Check Specific Job Status"', 'info');
        };
    </script>
</body>
</html>